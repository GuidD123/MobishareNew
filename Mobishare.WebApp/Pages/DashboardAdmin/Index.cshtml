@page
@model Mobishare.WebApp.Pages.DashboardAdmin.IndexModel
@{
    ViewData["Title"] = "Dashboard Admin - Mobishare";
    Layout = "_Layout";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-speedometer2 text-primary"></i> Dashboard Gestore</h2>
        <div>
            <span class="text-muted">Ultimo aggiornamento: @DateTime.Now.ToString("HH:mm")</span>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i> @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (Model.Dashboard == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Caricamento...</span>
            </div>
            <p class="mt-3 text-muted">Caricamento dati dashboard...</p>
        </div>
    }
    else
    {
        @if (!string.IsNullOrEmpty(Model.Dashboard.Messaggio))
        {
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <i class="bi bi-info-circle-fill"></i> @Model.Dashboard.Messaggio
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        @if (Model.IsGestore)
        {
            <div class="row mb-4">
                <div class="col-12">
                    <h4 class="mb-3">
                        <i class="bi bi-gear-fill"></i> Gestione Sistema
                    </h4>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card shadow-sm h-100">
                        <div class="card-body text-center p-4">
                            <i class="bi bi-building display-3 text-primary mb-3"></i>
                            <h5 class="card-title">Gestisci Parcheggi</h5>
                            <p class="text-muted">Aggiungi o disattiva Parcheggi (Manutenzione)</p>
                            <a asp-page="/DashboardAdmin/GestioneParcheggi" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> Vai alla Gestione
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card shadow-sm h-100">
                        <div class="card-body text-center p-4">
                            <i class="bi bi-bicycle display-3 text-success mb-3"></i>
                            <h5 class="card-title">Gestisci Mezzi</h5>
                            <p class="text-muted">Aggiungi, modifica o rimuovi mezzi dalla flotta</p>
                            <a asp-page="/DashboardAdmin/GestioneMezzi" class="btn btn-success">
                                <i class="bi bi-plus-circle"></i> Vai alla Gestione
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card shadow-sm h-100">
                        <div class="card-body text-center p-4">
                            <i class="bi bi-star-fill display-3 text-warning mb-3"></i>
                            <h5 class="card-title">Visualizza Feedback</h5>
                            <p class="text-muted">Monitora le recensioni e valutazioni degli utenti</p>
                            <a asp-page="/DashboardAdmin/VisualizzaFeedback" class="btn btn-warning">
                                <i class="bi bi-eye"></i> Vai ai Feedback
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Statistiche Corse -->
        <div class="row mb-4">
            <div class="col-12">
                <h4 class="mb-3">
                    <i class="bi bi-bicycle"></i> Statistiche Corse
                </h4>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card shadow-sm text-center">
                    <div class="card-body">
                        <i class="bi bi-graph-up display-4 text-primary"></i>
                        <h3 id="num-corse-totali" class="mt-3">@Model.Dashboard.NumeroCorseTotali</h3>
                        <p class="text-muted mb-0">Corse Totali</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card shadow-sm text-center">
                    <div class="card-body">
                        <i class="bi bi-calendar-check display-4 text-success"></i>
                        <h3 id="corse-oggi" class="mt-3">@Model.Dashboard.CorseOggi</h3>
                        <p class="text-muted mb-0">Corse Oggi</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card shadow-sm text-center">
                    <div class="card-body">
                        <i class="bi bi-calendar-week display-4 text-info"></i>
                        <h3 id="corse-settimana" class="mt-3">@Model.Dashboard.CorseUltimaSettimana</h3>
                        <p class="text-muted mb-0">Corse Ultima Settimana</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistiche Mezzi -->
        <div class="row mb-4">
            <div class="col-12">
                <h4 class="mb-3">
                    <i class="bi bi-scooter"></i> Stato Mezzi
                </h4>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card shadow-sm border-success">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="bi bi-check-circle"></i> Mezzi Disponibili</h6>
                    </div>
                    <div class="card-body text-center">
                        <h2 id="mezzi-disponibili" class="text-success">@Model.Dashboard.MezziDisponibili</h2>
                        <small class="text-muted">Pronti per l'uso</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card shadow-sm border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="bi bi-arrow-right-circle"></i> Mezzi In Uso</h6>
                    </div>
                    <div class="card-body text-center">
                        <h2 id="mezzi-inuso" class="text-primary">@Model.Dashboard.MezziInUso</h2>
                        <small class="text-muted">Attualmente prelevati</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card shadow-sm border-danger">
                    <div class="card-header bg-danger text-white">
                        <h6 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Mezzi Guasti</h6>
                    </div>
                    <div class="card-body text-center">
                        <h2 id="mezzi-guasti" class="text-danger">@Model.Dashboard.MezziGuasti</h2>
                        <small class="text-muted">Richiedono manutenzione</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grafico Distribuzione Mezzi + Gestione Utenti -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-3">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Distribuzione Mezzi</h5>
                    </div>
                    <div class="card-body">
                        @{
                            var totMezzi = Model.Dashboard.MezziDisponibili + Model.Dashboard.MezziInUso + Model.Dashboard.MezziGuasti;
                            var percDisponibili = totMezzi > 0 ? (double)Model.Dashboard.MezziDisponibili / totMezzi * 100 : 0;
                            var percInUso = totMezzi > 0 ? (double)Model.Dashboard.MezziInUso / totMezzi * 100 : 0;
                            var percGuasti = totMezzi > 0 ? (double)Model.Dashboard.MezziGuasti / totMezzi * 100 : 0;
                        }

                        <!-- Disponibili -->
                        <div class="mb-3" id="progress-disponibili">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Disponibili</span>
                                <strong class="text-success"><span id="perc-disponibili">@percDisponibili.ToString("0.0")</span>%</strong>
                            </div>
                            <div class="progress" style="height: 25px;" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="@percDisponibili">
                                <div class="progress-bar bg-success" style="width: @percDisponibili%">
                                    <span id="num-disponibili">@Model.Dashboard.MezziDisponibili</span>
                                </div>
                            </div>
                        </div>

                        <!-- In uso -->
                        <div class="mb-3" id="progress-inuso">
                            <div class="d-flex justify-content-between mb-1">
                                <span>In Uso</span>
                                <strong class="text-primary"><span id="perc-inuso">@percInUso.ToString("0.0")</span>%</strong>
                            </div>
                            <div class="progress" style="height: 25px;" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="@percInUso">
                                <div class="progress-bar bg-primary" style="width: @percInUso%">
                                    <span id="num-inuso">@Model.Dashboard.MezziInUso</span>
                                </div>
                            </div>
                        </div>

                        <!-- Guasti -->
                        <div class="mb-0" id="progress-guasti">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Guasti</span>
                                <strong class="text-danger"><span id="perc-guasti">@percGuasti.ToString("0.0")</span>%</strong>
                            </div>
                            <div class="progress" style="height: 25px;" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="@percGuasti">
                                <div class="progress-bar bg-danger" style="width: @percGuasti%">
                                    <span id="num-guasti">@Model.Dashboard.MezziGuasti</span>
                                </div>
                            </div>
                        </div>

                        <div class="mt-3 pt-3 border-top text-center">
                            <strong>Totale Mezzi: <span id="tot-mezzi">@totMezzi</span></strong>
                        </div>
                    </div>
                </div>
            </div>

            @if (Model.IsGestore)
            {
                <div class="col-lg-6 mb-3">
                    <div class="card shadow-sm">
                        <div class="card-header bg-warning">
                            <h5 class="mb-0"><i class="bi bi-people"></i> Gestione Utenti</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center mb-3">
                                <div class="col-6">
                                    <div class="p-3 border rounded">
                                        <h2 id="utenti-totali" class="text-primary mb-2">@Model.Dashboard.UtentiTotali</h2>
                                        <small class="text-muted">Utenti Totali</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-3 border rounded">
                                        <h2 id="utenti-sospesi" class="@(Model.Dashboard.UtentiSospesi > 0 ? "text-danger" : "text-success") mb-2">
                                            @Model.Dashboard.UtentiSospesi
                                        </h2>
                                        <small class="text-muted">Utenti Sospesi</small>
                                    </div>
                                </div>
                            </div>

                            @if (Model.Dashboard.UtentiSospesi > 0)
                            {
                                <div class="alert alert-warning mb-3">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <strong>Attenzione:</strong> Ci sono @Model.Dashboard.UtentiSospesi utenti sospesi.
                                </div>
                            }

                            <a asp-page="/Admin/GestioneUtenti" class="btn btn-warning w-100">
                                <i class="bi bi-people-fill"></i> Gestisci Utenti
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@{
    var jwt = HttpContextAccessor.HttpContext?.Session.GetString("JwtToken");
}
<script>
    if ('@jwt') {
        sessionStorage.setItem("jwtToken", '@jwt');
    }
</script>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"
        integrity="sha384-f1MzM6v4w7r3dM2AtFhBvBvq5z2gyqNnAW+u6rA9hAl1gCHwGjUqkCQg+XfB4cmN"
        crossorigin="anonymous"></script>


    <script>

        const token = sessionStorage.getItem("jwtToken"); 
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("https://localhost:7001/hub/notifiche", {
                accessTokenFactory: () => token
            })
            .withAutomaticReconnect()
            .configureLogging(signalR.LogLevel.Information)
            .build();

        // 2. Evento ricevuto dal server
        connection.on("AggiornaDashboard", data => {
            console.log("Dashboard aggiornata in tempo reale:", data);

            const totMezzi = data.MezziDisponibili + data.MezziInUso + data.MezziGuasti;
            const perc = (v) => totMezzi > 0 ? (v / totMezzi * 100) : 0;

            function setProgress(id, value, percSpanId, numSpanId) {
                const container = document.getElementById(id);
                if (!container) return;
                const bar = container.querySelector(".progress-bar");
                if (!bar) return;
                const p = perc(value);
                bar.style.width = p.toFixed(1) + "%";
                const prog = container.querySelector(".progress");
                if (prog) prog.setAttribute("aria-valuenow", p.toFixed(1));
                const percEl = document.getElementById(percSpanId);
                if (percEl) percEl.textContent = p.toFixed(1);
                const numEl = document.getElementById(numSpanId);
                if (numEl) numEl.textContent = value;
           }

            setProgress("progress-disponibili", data.MezziDisponibili, "perc-disponibili", "num-disponibili");
            setProgress("progress-inuso",       data.MezziInUso,       "perc-inuso",       "num-inuso");
            setProgress("progress-guasti",      data.MezziGuasti,      "perc-guasti",      "num-guasti");

            const totEl = document.getElementById("tot-mezzi");
            if (totEl) totEl.textContent = totMezzi;

            const sospesiEl = document.getElementById("utenti-sospesi");
            if (sospesiEl && typeof data.UtentiSospesi !== "undefined") {
                sospesiEl.textContent = data.UtentiSospesi;
                sospesiEl.classList.remove("text-success","text-danger");
                sospesiEl.classList.add(data.UtentiSospesi > 0 ? "text-danger" : "text-success");
            }

            const guastiEl = document.getElementById("mezzi-guasti");
            if (guastiEl) {
                const precedente = parseInt(guastiEl.textContent || "0");
                if (data.MezziGuasti > precedente) {
                    guastiEl.classList.add("bg-danger", "text-white");
                    setTimeout(() => guastiEl.classList.remove("bg-danger", "text-white"), 2000);
                    console.log("Nuovo mezzo guasto segnalato");
                }
                guastiEl.textContent = data.MezziGuasti;
            }


            // Mappa chiave → id HTML da aggiornare
            const mapping = {
                NumeroCorseTotali: "num-corse-totali",
                CorseOggi: "corse-oggi",
                CorseUltimaSettimana: "corse-settimana",
                MezziDisponibili: "mezzi-disponibili",
                MezziInUso: "mezzi-inuso",
                MezziGuasti: "mezzi-guasti",
                UtentiTotali: "utenti-totali",
                //UtentiSospesi: "utenti-sospesi"
            };

            for (const key in mapping) {
                const el = document.getElementById(mapping[key]);
                if (el && typeof data[key] !== "undefined") {
                    el.textContent = data[key];
                    el.classList.add("highlight");
                    setTimeout(() => el.classList.remove("highlight"), 600);
                }
            }
        });

        // Aggiornamento telemetria singoli mezzi
        connection.on("AggiornamentoTelemetria", function (data) {
            console.log("📡 Telemetria aggiornata:", data);

            let log = document.getElementById("telemetria-log");
            if (!log) {
                // Se non esiste ancora, crealo dinamicamente sotto le statistiche
                const container = document.querySelector(".container");
                const card = document.createElement("div");
                card.className = "card mt-4 shadow-sm";
                card.innerHTML = `
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-broadcast me-2"></i> Telemetria in tempo reale
                    </div>
                    <div class="card-body">
                        <p id="telemetria-log" class="text-muted mb-0">
                            In attesa di aggiornamenti dai mezzi...
                        </p>
                    </div>
                `;
                container.appendChild(card);
                log = document.getElementById("telemetria-log");
            }

                log.innerHTML = `
                    <strong>Mezzo ${data.matricola}</strong> 
                    → Stato: <span class="text-${data.stato === 'InUso' ? 'success' : data.stato === 'Guasto' ? 'danger' : 'secondary'}">
                    ${data.stato}</span>, 
                    Batteria: <strong>${data.livelloBatteria}%</strong> 
                    <small class="text-muted ms-2">(${new Date(data.timeStamp).toLocaleTimeString('it-IT')})</small>
                `;
        });


        // 3. Gestione connessione
        connection.start()
            .then(() => console.log("Connesso a NotificheHub"))
            .catch(err => console.error("Errore SignalR:", err));

        // 4. (CSS facoltativo per animazione highlight)
        const style = document.createElement('style');
        style.innerHTML = `
            .highlight {
                background: #fff3cd;
                transition: background 0.8s ease;
            }
        `;
        document.head.appendChild(style);
    </script>
}
