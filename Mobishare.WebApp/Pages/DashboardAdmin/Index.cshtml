@page
@model Mobishare.WebApp.Pages.DashboardAdmin.IndexModel
@{
    ViewData["Title"] = "Dashboard";
    Layout = "_Layout";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="bi bi-speedometer2 text-primary"></i> 
            Dashboard @(Model.IsGestore ? "Gestore" : "Utente")
        </h2>
        <div>
            <span class="text-muted">Ultimo aggiornamento: @DateTime.Now.ToString("HH:mm")</span>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i> @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (Model.Dashboard == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Caricamento...</span>
            </div>
            <p class="mt-3 text-muted">Caricamento dati dashboard...</p>
        </div>
    }
    else
    {
        <!-- Alert Messaggio se presente -->
        @if (!string.IsNullOrEmpty(Model.Dashboard.Messaggio))
        {
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <i class="bi bi-info-circle-fill"></i> @Model.Dashboard.Messaggio
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <!-- Statistiche Corse -->
        <div class="row mb-4">
            <div class="col-12">
                <h4 class="mb-3">
                    <i class="bi bi-bicycle"></i> Statistiche Corse
                </h4>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card shadow-sm text-center">
                    <div class="card-body">
                        <i class="bi bi-graph-up display-4 text-primary"></i>
                        <h3 class="mt-3">@Model.Dashboard.NumeroCorseTotali</h3>
                        <p class="text-muted mb-0">Corse Totali</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card shadow-sm text-center">
                    <div class="card-body">
                        <i class="bi bi-calendar-check display-4 text-success"></i>
                        <h3 class="mt-3">@Model.Dashboard.CorseOggi</h3>
                        <p class="text-muted mb-0">Corse Oggi</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card shadow-sm text-center">
                    <div class="card-body">
                        <i class="bi bi-calendar-week display-4 text-info"></i>
                        <h3 class="mt-3">@Model.Dashboard.CorseUltimaSettimana</h3>
                        <p class="text-muted mb-0">Corse Ultima Settimana</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistiche Mezzi -->
        <div class="row mb-4">
            <div class="col-12">
                <h4 class="mb-3">
                    <i class="bi bi-scooter"></i> Stato Mezzi
                </h4>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card shadow-sm border-success">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="bi bi-check-circle"></i> Mezzi Disponibili</h6>
                    </div>
                    <div class="card-body text-center">
                        <h2 class="text-success">@Model.Dashboard.MezziDisponibili</h2>
                        <small class="text-muted">Pronti per l'uso</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card shadow-sm border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="bi bi-arrow-right-circle"></i> Mezzi In Uso</h6>
                    </div>
                    <div class="card-body text-center">
                        <h2 class="text-primary">@Model.Dashboard.MezziInUso</h2>
                        <small class="text-muted">Attualmente prelevati</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card shadow-sm border-danger">
                    <div class="card-header bg-danger text-white">
                        <h6 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Mezzi Guasti</h6>
                    </div>
                    <div class="card-body text-center">
                        <h2 class="text-danger">@Model.Dashboard.MezziGuasti</h2>
                        <small class="text-muted">Richiedono manutenzione</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grafico Distribuzione Mezzi -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-3">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Distribuzione Mezzi</h5>
                    </div>
                    <div class="card-body">
                        @{
                            var totMezzi = Model.Dashboard.MezziDisponibili + Model.Dashboard.MezziInUso + Model.Dashboard.MezziGuasti;
                            var percDisponibili = totMezzi > 0 ? (double)Model.Dashboard.MezziDisponibili / totMezzi * 100 : 0;
                            var percInUso = totMezzi > 0 ? (double)Model.Dashboard.MezziInUso / totMezzi * 100 : 0;
                            var percGuasti = totMezzi > 0 ? (double)Model.Dashboard.MezziGuasti / totMezzi * 100 : 0;
                        }
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Disponibili</span>
                                <strong class="text-success">@percDisponibili.ToString("0.0")%</strong>
                            </div>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar bg-success" style="width: @percDisponibili%">
                                    @Model.Dashboard.MezziDisponibili
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>In Uso</span>
                                <strong class="text-primary">@percInUso.ToString("0.0")%</strong>
                            </div>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar bg-primary" style="width: @percInUso%">
                                    @Model.Dashboard.MezziInUso
                                </div>
                            </div>
                        </div>

                        <div class="mb-0">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Guasti</span>
                                <strong class="text-danger">@percGuasti.ToString("0.0")%</strong>
                            </div>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar bg-danger" style="width: @percGuasti%">
                                    @Model.Dashboard.MezziGuasti
                                </div>
                            </div>
                        </div>

                        <div class="mt-3 pt-3 border-top text-center">
                            <strong>Totale Mezzi: @totMezzi</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistiche Utenti (solo per Gestore) -->
            @if (Model.IsGestore)
            {
                <div class="col-lg-6 mb-3">
                    <div class="card shadow-sm">
                        <div class="card-header bg-warning">
                            <h5 class="mb-0"><i class="bi bi-people"></i> Gestione Utenti</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center mb-3">
                                <div class="col-6">
                                    <div class="p-3 border rounded">
                                        <h2 class="text-warning mb-2">@Model.Dashboard.UtentiSospesi</h2>
                                        <small class="text-muted">Utenti Sospesi</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-3 border rounded">
                                        <h2 class="text-success mb-2">€@Model.Dashboard.CreditoTotaleSistema.ToString("0.00")</h2>
                                        <small class="text-muted">Credito Totale Sistema</small>
                                    </div>
                                </div>
                            </div>

                            @if (Model.Dashboard.UtentiSospesi > 0)
                            {
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle"></i> 
                                    <strong>Attenzione:</strong> Ci sono @Model.Dashboard.UtentiSospesi utenti sospesi che potrebbero richiedere riattivazione.
                                </div>
                                <a asp-page="/Admin/Utenti" class="btn btn-warning w-100">
                                    <i class="bi bi-person-check"></i> Gestisci Utenti Sospesi
                                </a>
                            }
                            else
                            {
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle"></i> 
                                    Nessun utente sospeso al momento!
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
            else
            {
                <!-- Info Credito per Utente Normale -->
                <div class="col-lg-6 mb-3">
                    <div class="card shadow-sm">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="bi bi-wallet2"></i> Il Tuo Credito</h5>
                        </div>
                        <div class="card-body text-center">
                            @if (Model.Saldo != null)
                            {
                                <h1 class="display-4 text-success mb-3">€@Model.Saldo.CreditoAttuale.ToString("0.00")</h1>
                                
                                @if (Model.Saldo.UtenteAttivo)
                                {
                                    <span class="badge bg-success mb-3">Account Attivo</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger mb-3">Account Sospeso</span>
                                }

                                <hr/>

                                <div class="text-start">
                                    <p class="mb-2">
                                        <small class="text-muted">Totale Ricariche:</small>
                                        <strong class="float-end text-success">+€@Model.Saldo.TotaleRicariche.ToString("0.00")</strong>
                                    </p>
                                    <p class="mb-2">
                                        <small class="text-muted">Totale Spese:</small>
                                        <strong class="float-end text-danger">-€@Model.Saldo.TotaleSpese.ToString("0.00")</strong>
                                    </p>
                                </div>

                                <a asp-page="/Ricariche/Index" class="btn btn-success w-100 mt-3">
                                    <i class="bi bi-plus-circle"></i> Ricarica Credito
                                </a>
                            }
                            else
                            {
                                <p class="text-muted">Caricamento informazioni credito...</p>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>

        @if (Model.IsGestore)
        {
            <div class="row mb-4">
                <div class="col-12">
                    <h4 class="mb-3">
                        <i class="bi bi-gear-fill"></i> Gestione Sistema
                    </h4>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card shadow-sm h-100">
                        <div class="card-body text-center p-4">
                            <i class="bi bi-building display-3 text-primary mb-3"></i>
                            <h5 class="card-title">Gestisci Parcheggi</h5>
                            <p class="text-muted">Aggiungi, modifica o elimina parcheggi del sistema</p>
                            <a asp-page="/DashboardAdmin/GestioneParcheggi" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> Vai alla Gestione
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card shadow-sm h-100">
                        <div class="card-body text-center p-4">
                            <i class="bi bi-bicycle display-3 text-success mb-3"></i>
                            <h5 class="card-title">Gestisci Mezzi</h5>
                            <p class="text-muted">Aggiungi, modifica o rimuovi mezzi dalla flotta</p>
                            <a asp-page="/DashboardAdmin/GestioneMezzi" class="btn btn-success">
                                <i class="bi bi-plus-circle"></i> Vai alla Gestione
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Link Rapidi -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-link-45deg"></i> Azioni Rapide</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-2">
                                <a asp-page="/Mezzi/Index" class="btn btn-outline-primary w-100">
                                    <i class="bi bi-bicycle"></i> Vedi Mezzi
                                </a>
                            </div>
                            <div class="col-md-3 mb-2">
                                <a asp-page="/Parcheggi/Index" class="btn btn-outline-success w-100">
                                    <i class="bi bi-geo-alt"></i> Parcheggi
                                </a>
                            </div>
                            <div class="col-md-3 mb-2">
                                <a asp-page="/Corse/Index" class="btn btn-outline-info w-100">
                                    <i class="bi bi-list-check"></i> Storico Corse
                                </a>
                            </div>
                            @if (Model.IsGestore)
                            {
                                <div class="col-md-3 mb-2">
                                    <a asp-page="/Admin/Utenti" class="btn btn-outline-warning w-100">
                                        <i class="bi bi-people"></i> Gestisci Utenti
                                    </a>
                                </div>
                            }
                            else
                            {
                                <div class="col-md-3 mb-2">
                                    <a asp-page="/Profilo/Index" class="btn btn-outline-secondary w-100">
                                        <i class="bi bi-person"></i> Profilo
                                    </a>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Auto-refresh ogni 60 secondi
        setTimeout(function() {
            location.reload();
        }, 60000);
    </script>
}